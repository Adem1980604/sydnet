<!DOCTYPE html>
<html lang="da">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Portefølje detaljer</title>
  <link rel="stylesheet" href="/portefoljeDetalje.css">

    <!-- link til charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>

<body>

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="logo">
      <h3>SYDNET</h3>
    </div>

    <ul>
      <li><a href="/dashboard">Dashboard</a></li>
      <li><a href="/portefoljestyring/konto/<%= konto_id %>">Min porteføljeoversigt</a></li>
      <li><a href="/portefoljestyring/kontooplysninger">Kontooplysninger</a></li>

    </ul>


  </aside>

  <main class="main-content">
    <div class="header">
      <h1>
        <%= portefolje.navn %>
      </h1>
      <div class="header-buttons">
        <button class="handels-knap" onclick="åbnHistorikPopup()">Handels Historik</button>
        <button class="handels-knap" onclick="åbnPopup()">Opret Handel/Salg</button>
      </div>
    </div>


    <div class="grid-layout">
      <!-- Line Chart Placeholder (test) -->
      <div class="chart-card">
        <h3>Samlet Værdi af portefølje</h3>
        <div class="chart-placeholder" id="line-chart">
          <canvas id="accountChart"> 
          </canvas>
        </div>
      </div>

      <!-- Donut Chart og Total værdi -->
      <div class="summary-card">
        <div class="chart-placeholder" id="donut-chart">
          <canvas id="portfolioPieChart">
         
          </canvas>
        </div>

         <!-- Oprettels af salg -->
         <%
         // Opretter en tom liste til at holde overblik over hvad brugeren ejer
         const ejerListe = [];
       
         // Gennemgår alle handler (både køb og salg)
         for (let i = 0; i < handler.length; i++) {
           const h = handler[i]; // En enkelt handel
           const symbol = h.symbol;  // Symbol på værdipapiret (f.eks. AAPL)
           const antal = h.antal;    // Antal købt eller solgt
           const erSalg = h.salg_koeb;  // true hvis det er salg, false hvis det er køb
       
           let fundet = false; // Bruges til at tjekke om aktien allerede er i ejerlisten
       
           // Tjek om aktien allerede er i ejerListe
           for (let j = 0; j < ejerListe.length; j++) {
             if (ejerListe[j].symbol === symbol) {
               // Hvis det er salg, træk antal fra. Ellers læg til.
               if (erSalg) {
                 ejerListe[j].antal -= antal;
               } else {
                 ejerListe[j].antal += antal;
               }
               fundet = true;
               break; // Vi er færdige, så vi stopper løkken
             }
           }
       
           // Hvis aktien ikke var i listen, tilføj den som ny
           if (!fundet) {
             let antalTilføj;
             if (erSalg) {
               antalTilføj = -antal; // Sæt negativ hvis det er salg
             } else {
               antalTilføj = antal;  // Positiv hvis det er køb
             }
       
             // Tilføj aktien til ejerlisten
             ejerListe.push({
               symbol: symbol,
               antal: antalTilføj
             });
           }
         }
       
         // Kopiér listen så den kan bruges til visning i tabellen
         const ejerListeFiltreret = ejerListe;
       %>
       
        
      <!-- udrgning til samlet værdi af alle værdipapir i porteføljen -->
        <% 
        let totalVaerdi = 0;
        for (let i = 0; i < ejerListeFiltreret.length; i++) {
          const e = ejerListeFiltreret[i];
        
          if (e.antal > 0) {
            let pris = 0;
        
            for (let j = 0; j < handler.length; j++) {
              if (handler[j].symbol === e.symbol) {
                pris = handler[j].pris;
                break;
              }
            }
        
            totalVaerdi += e.antal * pris;
          }
        }        
        %>
        <ul class="egend">
          <li><span></span> AAPL - 35%</li>
          <li><span></span> AAPL - 35%</li>
          <li><span></span> AAPL - 35%</li>
          <li><span></span> AAPL - 35%</li>
        </ul>
        <div class="total-value">
          <p>Total værdi i DKK</p>
          <h2><%= totalVaerdi.toFixed(2) %> DKK</h2>
        </div>        
      </div>
    </div>

    <!-- Aktie tabel -->
    <section class="stock-table">
      <h3>Aktier i portefølje</h3>
      <table>
        <thead>
          <tr>
            <th>Navn</th>
            <th>Volume</th>
            <th>24h Change</th>
            <th>Pris</th>
            <th>Værdi</th>
          </tr>
        </thead>
    
            <!-- Tabel for akter brugern ejer Dummy data der skal erstates med live data -->
            <tbody>
              <% 
// Loop gennem listen over værdipapirer som brugeren ejer (efter køb/salg er beregnet)
for (let i = 0; i < ejerListeFiltreret.length; i++) {
  const e = ejerListeFiltreret[i]; // Hver aktie brugeren ejer

  // Vi skal finde navn og pris på aktien baseret på symbol
  let navn = "";
  let pris = 0;

  // Gennemgå alle handler for at finde den første med samme symbol
  for (let j = 0; j < handler.length; j++) {
    if (handler[j].symbol === e.symbol) {
      navn = handler[j].navn; // Sæt navnet
      pris = handler[j].pris; // Sæt den seneste pris (kun første match bruges)
      break; // Vi har fundet det vi skulle bruge
    }
  }

  // Vis kun aktier som brugeren stadig ejer (antal > 0)
  if (e.antal > 0) {
%>
    <tr>
      <td><%= navn %><br><small><%= e.symbol %></small></td>
      <td><%= e.antal %> stk.</td>
      <td class="positive">+1.27%</td> <!-- Her kan du vise ændring i værdi (live data)-->
      <td><%= pris %> DKK</td>
      <td><%= (e.antal * pris).toFixed(2) %> DKK</td>
    </tr>
    <td>
      <a href="/vaerdipapir/<%= e.symbol %>" class="handels-knap">Se detaljer</a> <!-- Knap til at se værdipapir information -->
    </td>
<% 
  } 
} 
%>

            </tbody>   
      </table>
    </section>
  </main>

  <!--pop up til opret handel eller salg-->
  <div id="popup" class="popup" style="display:none;">
    <div class="popup-indhold">
      <h2>Opret Handel</h2>

      <!--vi laver en switch mulighed så brugeren kan vælge om de vil sælge eller købe værdipapir-->

      <label>Vælg handelstype:</label>
      <label class="switch">
        <input type="checkbox" id="handelstype-toggle">
        <span class="slider round"></span>
      </label>
      <span id="handelstype-label">Køb</span>

      
      <!--search bar-->
      <input type="text" id="aktieSoeg" placeholder="Søg værdipapir">
      
      <!-- Lav drop down liste med de aktier vi kan handle med - aktieliste er allerede leveret som input ved load ad portefoljedetaljer -->
      <!--
      <select name="aktiesoegning:" id="aktieDropdown">
        <% for (let l=0; l < aktieliste.length; l++) { %>
          <option value=<%= aktieliste[l].symbol %>><%= aktieliste[l].symbol %></option>
        <% } %>
      </select>
    -->
      <button onclick="aktiesoeg()">Søg efter værdipapir</button>
      <ul id="vaerdiResultat"></ul>

      
      <!--Handels form-->
      <form id="handelForm">
        <input type="number" id="antal" placeholder="Antal" required>

        <!-- Pris per aktie (udfyldes automatisk) -->
        <label for="samlet_pris"> Pris</label> 
        <input type="number" id="samlet_pris" placeholder="pris" readonly>
       
        <!-- Beregnet pris vises her -->
        <p id="beregnet_pris">Samlet</p>

        <label>Værdi-type:</label>
        <select id="værditype" name="værditype" required>
          <option value="aktie">Aktie</option>
          <option value="obligation">Obligation</option>
          <option value="ETF">ETF</option>
        </select>

        <button class="popup-knap" type="submit">Bekræft Handel/Salg</button>
      </form>
      <button class="popup-knap" onclick="lukPopup()">Luk</button>

    </div>
  </div>

    <!--pop up til handels historik-->
  <div id="historikPopup" class="popup" style="display: none;">
    <div class="popup-indhold">
      <h2>Handelshistorik</h2>
      <table>
        <thead>
          <tr>
            <th>Dato</th>
            <th>Type</th>
            <th>Symbol</th>
            <th>Antal</th>
            <th>Pris</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody>
          <% for (let i = 0; i < handler.length; i++) {
              const h = handler[i];
              const total = (h.antal * h.pris).toFixed(2);
          %>
            <tr>
              <td><%= new Date(h.datotid).toLocaleDateString() %></td>
              <td>
                <% if (h.salg_koeb) { %>
                  Salg
                <% } else { %>
                  Køb
                <% } %>
              </td>              
              <td><%= h.symbol %></td>
              <td><%= h.antal %></td>
              <td><%= h.pris %> DKK</td>
              <td><%= total %> DKK</td>
            </tr>
          <% } %>
        </tbody>
      </table>
      <button onclick="lukPopup()">Luk</button>
    </div>
  </div>

 
  <!-- **************************** SCRIPT START ********************** -->
  <script>
    // tager fat i id for konti og portefølje og ejerliste
    const konto_id = "<%= konto_id %>";
    const portefolje_id = "<%= portefolje.portefoelje_id %>";
    const brugerensAktier = JSON.parse('<%- JSON.stringify(ejerListeFiltreret) %>');
    let nuvaerendeAktiePris;
    let symbol;
    let valgtAktie = [];


    async function aktiesoeg() {
          const symbol = document.getElementById("aktieSoeg").value;
          const response = await fetch(`/aktiesoeg/faaaktiekurs/${symbol}`);
          const data2 = await response.json();
          //console.log(Object.keys(data2["Time Series (60min)"])[0]);
          //console.log(Object.values(data2["Time Series (60min)"])[0]["1. open"]);
          nuvaerendeAktiePris = Object.values(data2["Time Series (60min)"])[0]["1. open"];
          console.log(nuvaerendeAktiePris); 
          valgtAktie.pris = nuvaerendeAktiePris;
          valgtAktie.symbol = symbol;  
          console.log(valgtAktie); 
    }  

    // funktion til at åbne popup for opret handel eller salg
    function åbnPopup() {
      document.getElementById("popup").style.display = "block";
    };

     // funktion til at åbne popup for handels historik
    function åbnHistorikPopup() {
      document.getElementById("historikPopup").style.display = "block";
    }

    // funktionen til at lukke popup
    function lukPopup() {
      // Lukker begge popup, hvis de er synlige
      document.getElementById('popup').style.display = 'none';
      document.getElementById('historikPopup').style.display = 'none';
    };

    // Henter HTML-elementerne til toggle-knappen og teksten der viser handelstypen
    const toggle = document.getElementById("handelstype-toggle");
    const label = document.getElementById("handelstype-label");

    // Når brugeren klikker på toggle-knappen (skifter mellem køb og salg)
    toggle.addEventListener("change", function () {
      // Hvis checkboxen er slået til (checked = true), så er det et salg
      if (toggle.checked) {
        label.textContent = "Salg"; // Vis teksten "Salg"
      } else {
        label.textContent = "Køb"; // Ellers vis "Køb"
      }
    });


    // Henter formular-elementet fra HTML (popup til handel)
    const form = document.getElementById("handelForm");

    // Når brugeren forsøger at indsende formularen
    form.addEventListener("submit", async function (event) {
      event.preventDefault();
    
      // Tjekker om brugeren har valgt "salg" via toggle-knap
      const isSalg = document.getElementById("handelstype-toggle").checked;
      let type;
      if (isSalg) {
        type = "salg";
      } else {
        type = "kob";
      }

      // Hvis brugeren vil sælge, skal vi tjekke om de ejer aktien og har nok
      if (type === "salg") {
        let fundet = false; // Bruges til at finde aktien i ejerlisten
        let ejerAntal = 0;  // Hvor mange aktier brugeren ejer
      
        // Gennemgå alle aktier brugeren ejer
        for (let i = 0; i < brugerensAktier.length; i++) {
          if (brugerensAktier[i].symbol === valgtAktie.symbol) {
            ejerAntal = brugerensAktier[i].antal;
            fundet = true;
            break;
          }
        }      
        const antalBrugerVilSælge = parseInt(document.getElementById("antal").value);
      
        // Hvis brugeren ikke ejer aktien, vis fejl
        if (!fundet) {
          alert("Du ejer ikke denne aktie og kan derfor ikke sælge den.");
          return; // Stop formularen
        }
      
        // Hvis brugeren prøver at sælge flere end de ejer
        if (antalBrugerVilSælge > ejerAntal) {
          alert(`Du prøver at sælge ${antalBrugerVilSælge} stk, men du ejer kun ${ejerAntal} stk.`);
          return; // Stop formularen
        }
      }

  // Opretter et data-objekt med de informationer der skal sendes til serveren
  const data = {
    konto_id,
    vaerditype: document.getElementById("værditype").value,
    antal: document.getElementById("antal").value,
    //pris: document.getElementById("samlet_pris").value,
    pris: nuvaerendeAktiePris,
    valuta: "DKK",
    type,
    symbol: valgtAktie.symbol
  };

  // Sender handlen til backend via fetch (POST-request)
  const svar = await fetch(`/portesiden/${portefolje_id}/handel`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
  });

  const resultat = await svar.json(); // Får svar tilbage fra serveren

  // Hvis alt gik godt
  if (resultat.success) {
    if (type === "kob") {
      alert("Handel oprettet!"); // Køb
    } else if (type === "salg") {
      alert("Salg gennemført!"); // Salg
    }
    lukPopup();       // Lukker popup-vinduet
    location.reload(); // Opdaterer siden så nye værdier vises
  } else {
    // Noget gik galt – vis en fejlbesked
    alert("Noget gik galt");
  }
});
    
//**************************** SEARCHBAR FUNKTIONALITET ********************** -->
// Dette er til searchbar her bruges der dummy data lige nu, men skal udvides med live data

 // vi antager at  brugeren ikke har valgt en aktie 
  
const input = document.getElementById("aktieSoeg");
console.log("**********************input********************");
console.log(input);
const resultatListe = document.getElementById("vaerdiResultat");


//// når brugeren søger 
//input.addEventListener("input", function () {
//  let søg = input.value
//  resultatListe.innerHTML = ""; // fjern gamle resultater
//  // loop gennem alle aktier (dummy data)
//  
//  // vi tager fat i prisen for den pågældende aktie og udfylder pris feltet på popup automatisk
//  console.log("**********************nuvaerendeAktiePris debug001 ********************");
// document.getElementById("samlet_pris").value = nuvaerendeAktiePris
//  valgtAktie.pris = nuvaerendeAktiePris;
//  //valgtAktie.symbol = min_aktie // nu har brugeren valgt en aktie og vi husker den
//});
////resultatListe.appendChild(li);

// opertter en funktion der ganger antallet af de valgte aktier med prisen 
async function beregnSamletPris(){  
  //Soeg efter aktien og find prisen ( vi gemme pris i global variable )
  await aktiesoeg();
  // henter antalet af aktier vagt 
  const antal = parseFloat(document.getElementById("antal").value);
  const visning = document.getElementById("beregnet_pris")

  if(antal > 0) {
    //let samlet = valgtAktie.pris * antal;     
    console.log(nuvaerendeAktiePris);
    console.log(antal);
    let samlet = nuvaerendeAktiePris * antal; 
    visning.textContent = ` Samlet: ${samlet} DKK`  // vi viser den samlet beregnet pris 
    document.getElementById("samlet_pris").value = nuvaerendeAktiePris
  };
  
};

  // Når brugeren skriver antal så kalder vi på funktionen der beregner prisen
document.getElementById("antal").addEventListener("input", function () {
  beregnSamletPris();
});


//*********************************************chart for line ********************************

async function visPortfolioGraf() {
    const ctx = document.getElementById('accountChart').getContext('2d');

const nu = new Date();
const maanedLabels = [];
const vaerdier = [];

const startMaaned = 0; // Januar = måned 0
const slutMaaned = nu.getMonth(); // Aktuel måned (0-indekseret)

for (let m = startMaaned; m <= slutMaaned; m++) {
  dato = new Date(nu.getFullYear(), m, 1);
  maanedLabels.push(dato.toLocaleDateString('da-DK', { month: 'short'}));

  // Dummy data, til totalværdi for grafen
  if (m < slutMaaned) {
    vaerdier.push(Math.floor(Math.random() * 5000) + 1000);
  } else {
    vaerdier.push(<%= totalVaerdi %>); // Faktisk værdi fra EJS for den aktuelle måned
  }
}


    // Opsæt data og konfiguration
    const data = {
      labels: maanedLabels,
      datasets: [{
        label: "Porteføljeværdi",
        data: vaerdier,
        borderColor: '#7c4dff',
        backgroundColor: 'rgba(124, 77, 255, 0.2)',
        fill: true,
        tension: 0.4,
        borderWidth: 2
      }]
    };

    const config = {
      type: 'line',
      data: data,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            labels: { color: '#ffffff' }
          },
          tooltip: {
            callbacks: {
              title: function (tooltipItems) {
                return tooltipItems[0].label; // måned og år vises som tooltip
              }
            }
          }
        },
        scales: {
          x: {
            ticks: {
              color: '#ffffff'
            },
            grid: {
              color: 'rgba(255, 255, 255, 0.1)'
            }
          },
          y: {
            ticks: {
              color: '#ffffff',
              callback: function (value) {
                return value.toLocaleString('da-DK') + " DKK";
              }
            },
            grid: {
              color: 'rgba(255, 255, 255, 0.1)'
            },
            title: {
              display: true,
              text: "Værdi (DKK)",
              color: '#ffffff'
            }
          }
        }
      }
    };

    new Chart(ctx, config);
  }

  visPortfolioGraf();


 //**************************** piechart **********************

 const donutLabels = []; // array der indeholder navne og symboler på akten
  const donutData = []; // array der indholder værdierne for porteføljen 


  // går igennem alle aktier brugeren ejer 
  <% for (let i = 0; i < ejerListeFiltreret.length; i++) {
       const e = ejerListeFiltreret[i];

       if (e.antal > 0) {
         let pris = 0;
         let navn = "";

         // Find pris og navn for symbolet
         for (let j = 0; j < handler.length; j++) {
           if (handler[j].symbol === e.symbol) {
             pris = handler[j].pris;
             navn = handler[j].navn;
             break;
           }
         }

         const værdi = Math.round(e.antal * pris * 100) / 100; // udregner værdi
  %>   // psu
         donutLabels.push("<%= navn %> (<%= e.symbol %>)");
         donutData.push(<%= værdi %>);
  <%   }
     } %>
    


      // Funktion der laver én tilfældig farve
  function randomRgbFarve() {
  const r = Math.floor(Math.random() * 80) + 60;  
  const g = Math.floor(Math.random() * 80) + 80;   
  const b = Math.floor(Math.random() * 100) + 100; 
  return `rgb(${r}, ${g}, ${b})`;
}


  // Funktion der laver en array af tilfældige farver
  function genererMangeTilfaeldigeFarver(antal) {
    const farver = [];
    for (let i = 0; i < antal; i++) {
      farver.push(randomRgbFarve());
    }
    return farver;
  }

function visDonutChart() {
  const ctx = document.getElementById('portfolioPieChart').getContext('2d');

  // Labels og data fra EJS (allerede genereret ovenfor)
  let total = 0;
  for (let i = 0; i < donutData.length; i++) {
    total += donutData[i];
  }

  let labels = [];
  for (let i = 0; i < donutLabels.length; i++) {
    let procent = (donutData[i] / total) * 100;
    procent = procent.toFixed(1);
    labels.push(donutLabels[i] + " (" + procent + "%)");
  }



  const data = {
    labels: labels,
    datasets: [{
      data: donutData,
      backgroundColor:genererMangeTilfaeldigeFarver(donutData.length),
      borderColor: '#ffffff',
      borderWidth: 2,
      cutout: '65%'
    }]
  };

  const config = {
    type: 'doughnut',
    data: data,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'right',
          labels: {
            color: '#ffffff',
            font: {
              size: 14,
              family: 'Arial, sans-serif'
            },
            padding: 15,
            usePointStyle: true
          }
        },
        title: {
          display: true,
          text: 'Fordeling af værdi i portefølje',
          color: '#ffffff',
          font: {
            size: 14,
            weight: 'bold',
            family: 'Arial, sans-serif'
          },
          padding: {
            bottom: 20
          }
        }
      },
      layout: {
        padding: {
          top: 20,
          bottom: 20,
          left: 20,
          right: 20
        }
      }
    }
  };



  new Chart(ctx, config);


};

  visDonutChart();


  </script>

</body>

</html>