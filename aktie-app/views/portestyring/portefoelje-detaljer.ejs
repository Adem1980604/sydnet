<!DOCTYPE html>
<html lang="da">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Portefølje detaljer</title>
  <link rel="stylesheet" href="/portefoljeDetalje.css">
</head>

<body>

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="logo">
      <h3>SYDNET</h3>
    </div>

    <ul>
      <li><a href="/dashboard">Dashboard</a></li>

      <li><a href="/portefoljestyring/konto/<%= konto_id %>">Min porteføljeoversigt</a></li>

      <li><a href="/portefoljestyring/kontooplysninger">Accounts</a></li>

    </ul>


  </aside>

  <main class="main-content">
    <div class="header">
      <h1>
        <%= portefolje.navn %>
      </h1>
      <div class="header-buttons">
        <button class="handels-knap">Handels Historik</button>
        <button class="handels-knap" onclick="åbnPopup()">Opret Handel</button>
      </div>
    </div>


    <div class="grid-layout">
      <!-- Line Chart Placeholder -->
      <div class="chart-card">
        <h3>Samlet Værdi af portefølje</h3>
        <div class="chart-placeholder" id="line-chart"></div>
      </div>

      <!-- Donut Chart og Total værdi -->
      <div class="summary-card">
        <div class="chart-placeholder" id="donut-chart"></div>
        <ul class="legend">
          <li><span></span> AAPL - 35%</li>
          <li><span></span> AAPL - 35%</li>
          <li><span></span> AAPL - 35%</li>
          <li><span></span> AAPL - 35%</li>
        </ul>
        <div class="total-value">
          <p>Total værdi i DKK</p>
          <h2>100.000 DKK</h2>
        </div>
      </div>
    </div>

    <!-- Aktie tabel -->
    <section class="stock-table">
      <h3>Aktier i portefølje</h3>
      <table>
        <thead>
          <tr>
            <th>Navn</th>
            <th>Volume</th>
            <th>24h Change</th>
            <th>Pris</th>
            <th>Værdi</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <!-- Dummy data der skal erstates med live data -->
            <td>Apple<br><small>AAPL</small></td>
            <td>1 stk.</td>
            <td class="positive">+1.27%</td>
            <td>100 DKK</td>
            <td>3.000 DKK</td>
          </tr>
          <tr>
            <td>Apple<br><small>AAPL</small></td>
            <td>1 stk.</td>
            <td class="positive">+1.27%</td>
            <td>100 DKK</td>
            <td>3.000 DKK</td>
          </tr>
          <tr>
            <td>Apple<br><small>AAPL</small></td>
            <td>1 stk.</td>
            <td class="positive">+1.27%</td>
            <td>100 DKK</td>
            <td>3.000 DKK</td>
          </tr>
          <tr>
            <td>Apple<br><small>AAPL</small></td>
            <td>1 stk.</td>
            <td class="negative">+1.27%</td>
            <td>100 DKK</td>
            <td>3.000 DKK</td>
          </tr>
        </tbody>
      </table>
    </section>
  </main>

  <!--pop up-->
  <div id="popup" class="popup" style="display:none;">
    <div class="popup-indhold">

   

      <h2>Opret Handel</h2>

      <!--vi laver en switch mulighed så brugeren kan vælge om de vil sælge eller købe værdipapir-->

      <label>Vælg handelstype:</label>
      <label class="switch">
        <input type="checkbox" id="handelstype-toggle">
        <span class="slider round"></span>
      </label>
      <span id="handelstype-label">Køb</span>

<!--search bar-->
<input type="text" id="aktieSøg" placeholder="Søg værdipapir">
<ul id="vaerdiResultat"></ul>

      <!--Handels form-->

      <form id="handelForm">


        <input type="number" id="antal" placeholder="Antal" required>

        <!-- Pris per aktie (udfyldes automatisk) -->
        <label for="samlet_pris"> Pris</label> 
        <input type="number" id="samlet_pris" placeholder="pris" readonly>
       
        <!-- Beregnet pris vises her -->
        <p id="beregnet_pris">Samlet</p>

        <label>Værdi-type:</label>
        <select id="værditype" name="værditype" required>
          <option value="aktie">Aktie</option>
          <option value="obligation">Obligation</option>
          <option value="ETF">ETF</option>
        </select>

        <button class="popup-knap" type="submit">Bekræft Handel</button>
      </form>
      <button class="popup-knap" onclick="lukPopup()">Luk</button>

    </div>
  </div>

    <!-- **************************** SCRIPT START ********************** -->
     
  <script>


    // tager fat i id for konti og portefølje ( jeg tror det skla bruges til backedt senere hen) 
    const konti_id = "<%= konto_id %>";
    const portefolje_id = "<%= portefolje.id %>";


    let handelstype = "køb" // vi antager at brugeren vil køber



    // funktion til at åbne popup
    function åbnPopup() {
      document.getElementById("popup").style.display = "block";
    };

    // funktionen til at lukke popup
    function lukPopup() {
      // Lukker begge popup, hvis den er synlig
      document.getElementById('popup').style.display = 'none';

    };

    // funktion til at opdatere handelstype
    const toggle = document.getElementById("handelstype-toggle");
    const label = document.getElementById("handelstype-label");

    toggle.addEventListener("change", function () {
      if (toggle.checked) {
        label.textContent = "Salg";
        handelstype = "salg";
      } else {
        label.textContent = "Køb";
        handelstype = "køb";
      }
    });

    // nu tager vi fat i vores data

    document.getElementById("handelForm").addEventListener("submit", async function (element) {
      element.preventDefault();

      const data = {
        konto_id,
        vaerditype: document.getElementById("værditype").value,
        antal: document.getElementById("antal").value,
        pris: document.getElementById("samlet_pris").value,
        valuta: "DKK",
        type: handelstype,
        vpoplysninger_id: 1 // fx midlertidigt test-id 
      };

      const svar = await fetch(`/portesiden/${portefolje_id}/handel`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });

      const resultat = await svar.json();

      if (resultat.success) {
        alert("Handel oprettet!");
        lukPopup();
      } else {
        alert("Noget gik galt");
      }
    });

    
    //**************************** SEARCHBAR FUNKTIONALITET ********************** -->

    // Dette er til searchbar her bruges der dummy data lige nu, men skal udvides med live data


  let valgtAktie = null; // vi antager at  brugeren ikke har valgt en aktie 

const aktier = [
  { symbol: "AAPL", navn: "Apple Inc.", pris: 145 },
  { symbol: "TSLA", navn: "Tesla", pris: 215 },
  { symbol: "MSFT", navn: "Microsoft", pris: 320 },
  { symbol: "NFLX", navn: "Netflix", pris: 405 }
];


const input = document.getElementById("aktieSøg");
const resultatListe = document.getElementById("vaerdiResultat");

// når brugeren søger 
input.addEventListener("input", function () {
  let søg = input.value

  resultatListe.innerHTML = ""; // fjern gamle resultater


  // loop gennem alle aktier (dummy data)
  for (let i = 0; i < aktier.length; i++) {
    let aktie = aktier[i];
    let symbol = aktie.symbol.toLowerCase();
    let navn = aktie.navn.toLowerCase();

// tjek om søg findes i symbol eller navn 
if(symbol.includes(søg)|| navn.includes(søg)){
  let li = document.createElement("li"); // vi laver en liste element som viser aktien
  li.textContent = `${aktie.symbol} - ${aktie.navn}`; // her stiller vi dem op
 

  // opretter klikke funktionaliteten 
  li.addEventListener("click", function () {
  input.value = aktie.symbol;  // ticker-symbolet automatisk bliver sat ind i søgefeltet,
  resultatListe.innerHTML = ""; // luk listen

  // vi tager fat i prisen for den pågældende aktie og udfylder pris feltet på popup automatisk
  document.getElementById("samlet_pris").value = aktie.pris 
  valgtAktie = aktie // nu har brugeren valgt en aktie og vi husker den

  });
  resultatListe.appendChild(li);
  }
}
});


// opertter en funktion der ganger antallet af de valgte aktier med prisen 
  function  beregnSamletPris(){

// henter antalet af aktier vagt 
const antal = parseFloat(document.getElementById("antal").value);
 const visning = document.getElementById("beregnet_pris")


      if(antal > 0) {
      let samlet = valgtAktie.pris * antal; 

    visning.textContent = ` Samlet: ${samlet} DKK`  // vi viser den samlet beregnet pris 
  
      };
    };

  // Når brugeren skriver antal så kalder vi på funktionen der beregner prisen
document.getElementById("antal").addEventListener("input", function () {
  beregnSamletPris();
});

  </script>

</body>

</html>